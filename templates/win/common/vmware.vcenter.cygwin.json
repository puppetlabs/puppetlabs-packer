{
  "variables": {
    "template_config"          : "vcenter",
    "provisioner"              : "vmware",

    "guest_os_type"            : "windows9_64Guest",

    "vm_version"               : "13",
    "firmware"                 : "efi",
    "winrm_username"           : "Administrator",
    "winrm_password"           : "PackerAdmin",
    "winrm_timeout"            : "8h",
    "disk_size"                : "61440",
    "memsize"                  : "4096",
    "RAM_reserve_all"          : "true",
    "numvcpus"                 : "2",
    "disk_controller_type"     : "pvscsi",
    "disk_thin_provisioned"    : "true",
    "shutdown_command"         : "powershell -executionpolicy bypass -File C:\\Packer\\Scripts\\init-sysprep.ps1 -ArumentList \"-Shutdown\" >> C:\\Packer\\Logs\\Init-Sysprep.log 2>&1",
    "shutdown_timeout"         : "1h",

    "qa_root_passwd"           : "{{env `QA_ROOT_PASSWD_PLAIN`}}",

    "packer_vcenter_host"      : "{{env `PACKER_VCENTER_HOST`}}",
    "packer_vcenter_username"  : "{{env `PACKER_VCENTER_USERNAME`}}",
    "packer_vcenter_password"  : "{{env `PACKER_VCENTER_PASSWORD`}}",
    "packer_vcenter_dc"        : "{{env `PACKER_VCENTER_DC`}}",
    "packer_vcenter_cluster"   : "{{env `PACKER_VCENTER_CLUSTER`}}",
    "packer_vcenter_datastore" : "{{env `PACKER_VCENTER_DATASTORE`}}",
    "packer_vcenter_folder"    : "{{env `PACKER_VCENTER_FOLDER`}}",
    "packer_vcenter_net"       : "{{env `PACKER_VCENTER_NET`}}",
    "packer_vcenter_insecure"  : "{{env `PACKER_VCENTER_INSECURE`}}",
    "packer_vcenter_build_host": "{{env `PACKER_VCENTER_BUILD_HOST`}}",

    "packer_sha"               : "{{env `PACKER_SHA`}}",
    "packer_download_dir"      : "C:/Packer/Downloads"

  },

  "description": "Builds a Windows template VM for use in VMware/cygwin directly on vcenter",

  "builders": [
    {
      "type": "vsphere-iso",

      "name"                   : "{{user `template_name`}}-{{user `provisioner`}}-{{user `template_config`}}",
      "vm_name"                :  "{{user `template_name`}}-{{user `version`}}",

      "vcenter_server"         : "{{user `packer_vcenter_host`}}",
      "insecure_connection"    : "{{user `packer_vcenter_insecure`}}",
      "username"               : "{{user `packer_vcenter_username`}}",
      "password"               : "{{user `packer_vcenter_password`}}",
      "datacenter"             : "{{user `packer_vcenter_dc`}}",
      "cluster"                : "{{user `packer_vcenter_cluster`}}",
      "host"                   : "{{user `packer_vcenter_build_host`}}",
      "convert_to_template"    : "false",
      "folder"                 : "{{user `packer_vcenter_folder`}}",
      "CPUs"                   : "{{user `numvcpus`}}",
      "RAM"                    : "{{user `memsize`}}",
      "RAM_reserve_all"        : "{{user `RAM_reserve_all`}}",
      "network"                : "{{user `packer_vcenter_net`}}",
      "network_card"           : "vmxnet3",
      "guest_os_type"          : "{{user `guest_os_type`}}",
      "datastore"              : "{{user `packer_vcenter_datastore`}}",
      "disk_controller_type"   : "{{user `disk_controller_type`}}",
      "disk_thin_provisioned"  : "{{user `disk_thin_provisioned`}}",
      "disk_size"              : "{{user `disk_size`}}",
      "boot_order"             : "disk,cdrom",
      "boot_wait"              : "10s",
      "boot_command" : [
        "<down><down><enter><wait><spacebar><wait><spacebar><wait><spacebar><wait><spacebar><wait><spacebar><wait><spacebar>"
      ],

      "shutdown_command"  : "{{user `shutdown_command`}}",
      "shutdown_timeout"  : "{{user `shutdown_timeout`}}",

      "floppy_files": [
        "./tmp/autounattend.xml",
        "./files/platform-packages.ps1",
        "../../common/scripts/common/windows-env.ps1",
        "../../common/scripts/bootstrap/bootstrap-base.bat",
        "../../common/scripts/bootstrap/start-pswindowsupdate.ps1",
        "../../common/scripts/bootstrap/shutdown-packerbuild.ps1",
        "../../common/scripts/bootstrap/startup-profile.ps1"
      ],
      "iso_paths": [
        "[AI_Insurgency_Test_Images] iso/en_windows_10_business_editions_version_1803_updated_march_2018_x64_dvd_12063333.iso",
        "[AI_Insurgency_Test_Images] iso/windows.iso"
      ],

      "communicator"      : "winrm",
      "winrm_username"    : "{{user `winrm_username`}}",
      "winrm_password"    : "{{user `winrm_password`}}",
      "winrm_timeout"     : "{{user `winrm_timeout`}}",

      "configuration_parameters": {
        "firmware"                                 : "{{user `firmware`}}",

        "gui.fitguestusingnativedisplayresolution" : "FALSE",
        "devices.hotplug"                          : "false",
        "vcpu.hotadd"                              : "TRUE",
        "mem.hotadd"                               : "TRUE",

        "tools.syncTime"                           : "FALSE",
        "time.synchronize.continue"                : "FALSE",
        "time.synchronize.restore"                 : "FALSE",
        "time.synchronize.resume.disk"             : "FALSE",
        "time.synchronize.shrink"                  : "FALSE",
        "time.synchronize.tools.startup"           : "FALSE",
        "time.synchronize.tools.enable"            : "FALSE",
        "time.synchronize.resume.host"             : "FALSE"
      }
    }
  ],
  "provisioners": [
    {
      "type": "powershell",
      "remote_path": "{{user `packer_downloads_dir`}}/print-pswindowslog.ps1",
      "inline": [
        "Write-Output 'Executing Powershell Script: print-pswindowslog.ps1'",
        "Get-Content C:\\Packer\\Logs\\start-pswindowsupdate.log | foreach {Write-Output $_}",
        "Start-Sleep -Seconds 10"
      ]
    },
    {
      "type": "file",
      "source": "../../common/scripts/bootstrap/shutdown-packerbuild.ps1",
      "destination": "C:\\Packer\\Scripts\\shutdown-packerbuild.ps1"
    },

    {
      "type": "file",
      "source": "../../common/puppet/",
      "destination": "C:\\Packer\\puppet\\modules"
    },
    {
      "type": "file",
      "source": "../../common/scripts/common/",
      "destination": "C:\\Packer\\Scripts"
    },
    {
      "type": "file",
      "source": "../../common/scripts/bootstrap/shutdown-packerbuild.ps1",
      "destination": "C:\\Packer\\Scripts\\shutdown-packerbuild.ps1"
    },
    {
      "type": "file",
      "source": "../../common/scripts/vmpooler/",
      "destination": "C:\\Packer\\Scripts"
    },
    {
      "type": "file",
      "source": "../../common/scripts/config/",
      "destination": "C:\\Packer\\Config"
    },
    {
      "type": "file",
      "source": "./tmp/post-clone.autounattend.xml",
      "destination": "C:\\Packer\\Config\\post-clone.autounattend.xml"
    },
    {
      "type": "powershell",
      "script" : "../../common/scripts/provisioners/install-win-packages.ps1"
    },
    {
      "type": "windows-restart"
    },
    {
      "type"   : "powershell",
      "script" : "../../common/scripts/provisioners/install-cygwin.ps1",
      "environment_vars" : [
        "QA_ROOT_PASSWD={{user `qa_root_passwd`}}"
      ]
    },
    {
      "type": "windows-restart"
    },
    {
      "type": "powershell",
      "script" : "../../common/scripts/provisioners/puppet-configure.ps1",
      "environment_vars" : [
        "QA_ROOT_PASSWD={{user `qa_root_passwd`}}",
        "PackerTemplateName={{user `template_name`}}-{{user `version`}}",
        "PackerSHA={{user `packer_sha`}}",
        "PackerTemplateType=vmpooler"
      ]
    },
    {
      "type": "windows-restart"
    },
    {
      "type": "powershell",
      "script" : "../../common/scripts/provisioners/config-winsettings.ps1"
    },
    {
      "type": "powershell",
      "script" : "../../common/scripts/provisioners/cleanup-host.ps1"
    },
    {
      "type"   : "powershell",
      "script" : "../../common/scripts/provisioners/clean-disk-dism.ps1"
    },
    {
      "type": "windows-restart"
    },
    {
      "type"   : "powershell",
      "script" : "../../common/scripts/provisioners/clean-disk-sdelete.ps1"
    }
  ]
}
